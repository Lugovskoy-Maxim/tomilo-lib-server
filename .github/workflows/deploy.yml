name: Deploy to home server - Server Build

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to home server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            echo "üöÄ Deploying to cloud.ru server..."

            PROJECT_DIR="/home/${{ secrets.VM_USERNAME }}/tomilo-lib-server"
            cd "$PROJECT_DIR"

            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git fetch origin
            git reset --hard origin/main

            # –ü–æ–¥–≥—Ä—É–∂–∞–µ–º nvm, –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              source "$HOME/.nvm/nvm.sh"
            else
              echo "nvm is not installed. Installing nvm..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
              source "$HOME/.nvm/nvm.sh"
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js 20
            if ! nvm ls 20 &> /dev/null; then
              echo "Installing Node.js 20..."
              nvm install 20
            fi
            nvm use 20
            nvm alias default 20

            # –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "Installing dependencies..."
            rm -rf node_modules
            npm install

            # –£–±–µ–¥–∏–º—Å—è —á—Ç–æ MongoDB —Ä–∞–±–æ—Ç–∞–µ—Ç
            echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl restart mongod
            sleep 3

            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if [ -f create-user.js ]; then
              echo "Creating MongoDB user..."
              sleep 2
              node create-user.js || echo "User creation completed"
            fi

            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            npm run build

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–±–æ—Ä–∫—É
            if [ -f dist/main.js ]; then
              echo "Build successful"
            else
              echo "Build failed!"
              exit 1
            fi

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            pm2 stop tomilo-lib-server 2>/dev/null || true
            pm2 delete tomilo-lib-server 2>/dev/null || true
            pm2 start dist/main.js --name "tomilo-lib-server"
            
            # –ñ–¥–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º
            sleep 5
            echo "PM2 status:"
            pm2 status
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏
            if pm2 status | grep -q "errored"; then
              echo "Application errors:"
              pm2 logs tomilo-lib-server --lines 20
              exit 1
            else
              echo "‚úÖ Successfully deployed!"
            fi
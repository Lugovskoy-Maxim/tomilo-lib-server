name: Deploy to home server - Docker

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Ð”Ð»Ñ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ñ… Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ² Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to home server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            echo "ðŸš€ Deploying to cloud.ru server..."
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
            PROJECT_DIR="/home/${{ secrets.VM_USERNAME }}/tomilo-lib-server"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            
            # 1. ÐšÐ›ÐžÐÐ˜Ð ÐžÐ’ÐÐÐ˜Ð•: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¼ÐµÑ‚Ð¾Ð´ Ð±ÐµÐ· SSH ÐºÐ»ÑŽÑ‡Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
            echo "ðŸ“¥ Updating repository..."
            if [ ! -d .git ]; then
              # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· HTTPS Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼ (ÑƒÐ¶Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½ Ð² actions/checkout)
              # Ð˜Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð´ Ð¸Ð· Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ³Ð¾ ÑˆÐ°Ð³Ð°
              echo "âŒ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. ÐÑƒÐ¶ÐµÐ½ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´."
              exit 1
            else
              # ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ - Ð¾Ð½ ÑƒÐ¶Ðµ ÑÐºÐ°Ñ‡Ð°Ð½ Ð² GitHub Actions
              # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ rsync Ð¸Ð»Ð¸ scp
              echo "ðŸ“¤ Copying files from GitHub Actions runner..."
            fi
            
            # Ð’Ð¼ÐµÑÑ‚Ð¾ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ, ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· runner
            # Ð­Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚ÑÑ Ð”Ðž ÑÑ‚Ð¾Ð³Ð¾ ÑˆÐ°Ð³Ð°, Ñ‡ÐµÑ€ÐµÐ· scp Ð¸Ð»Ð¸ rsync
            
            # 2. Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ NODE.JS (Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ð»Ð°Ð³Ð°ÐµÐ¼, Ñ‡Ñ‚Ð¾ nvm ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½)
            echo "ðŸ”§ Setting up Node.js..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Node.js 20
            if ! nvm ls 20 &> /dev/null; then
              echo "Installing Node.js 20..."
              nvm install 20
            fi
            nvm use 20
            
            echo "Node.js: $(node --version)"
            echo "npm: $(npm --version)"
            
            # 3. ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð¯ .env
            if [ -f .env.example ] && [ ! -f .env ]; then
              cp .env.example .env
            fi
            
            if [ -f .env ]; then
              # Ð‘Ð¾Ð»ÐµÐµ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð°Ñ Ð·Ð°Ð¼ÐµÐ½Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ PORT=3000
              sed -i 's/^PORT=3000$/PORT=3001/' .env
              # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ FRONTEND_URL ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
              grep -q "^FRONTEND_URL=" .env || echo "FRONTEND_URL=https://tomilo-lib.ru" >> .env
              sed -i 's|^FRONTEND_URL=.*|FRONTEND_URL=https://tomilo-lib.ru|' .env
            fi
            
            # 4. Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ Ð—ÐÐ’Ð˜Ð¡Ð˜ÐœÐžÐ¡Ð¢Ð•Ð™ Ð˜ Ð¡Ð‘ÐžÐ ÐšÐ
            echo "ðŸ“¦ Installing dependencies..."
            npm ci --only=production  # Ð‘Ð¾Ð»ÐµÐµ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹, Ñ‡ÐµÐ¼ npm install
            npm run build
            
            # 5. Ð—ÐÐŸÐ£Ð¡Ðš MONGODB Ð’ DOCKER
            echo "ðŸ³ Managing MongoDB container..."
            
            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¢ÐžÐ›Ð¬ÐšÐž Ð½Ð°Ñˆ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
            docker stop mongo-tomilo 2>/dev/null || true
            docker rm mongo-tomilo 2>/dev/null || true
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ ÑÐ²Ð½Ñ‹Ð¼ Ð¸Ð¼ÐµÐ½ÐµÐ¼
            docker run -d \
              --name mongo-tomilo \
              -p 27017:27017 \
              -e MONGO_INITDB_ROOT_USERNAME=admin \
              -e MONGO_INITDB_ROOT_PASSWORD=password123 \
              -v mongo-tomilo-data:/data/db \
              --restart unless-stopped \
              mongo:latest
            
            # Ð–Ð´ÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Ñ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð¾Ð¼
            echo "â³ Waiting for MongoDB..."
            for i in {1..30}; do
              if docker exec mongo-tomilo mongosh --quiet --eval "db.adminCommand('ping')" &>/dev/null; then
                echo "âœ… MongoDB ready after ${i}s"
                break
              fi
              sleep 1
              if [ $i -eq 30 ]; then
                echo "âŒ MongoDB failed to start in 30s"
                docker logs mongo-tomilo
                exit 1
              fi
            done
            
            # 6. Ð—ÐÐŸÐ£Ð¡Ðš ÐŸÐ Ð˜Ð›ÐžÐ–Ð•ÐÐ˜Ð¯ Ð§Ð•Ð Ð•Ð— PM2
            echo "ðŸ”„ Managing application with PM2..."
            
            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ PM2 ÐµÑÐ»Ð¸ Ð½ÐµÑ‚
            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
            pm2 restart tomilo-lib-server || \
            pm2 start dist/main.js --name "tomilo-lib-server"
            
            pm2 save
            pm2 startup 2>/dev/null || true
            
            echo "ðŸ“Š Deployment status:"
            echo "MongoDB: $(docker ps --filter name=mongo-tomilo --format '{{.Status}}')"
            echo "App: $(pm2 jlist | jq -r '.[] | select(.name=="tomilo-lib-server") | .status')"
            
            echo "âœ… Deployment completed successfully!"

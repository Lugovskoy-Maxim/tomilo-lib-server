name: Deploy NestJS to VM

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Deploy to VM
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          password: ${{ secrets.VM_PASSWORD }}
          command: |
            echo "üöÄ Starting deployment..."
            
            # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            mkdir -p /home/maxim/apps/my-nest-app
            cd /home/maxim/apps/my-nest-app
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ)
            pm2 stop my-nest-app || true
            pm2 delete my-nest-app || true
            docker-compose down || true
            
            # –ö–ª–æ–Ω–∏—Ä—É–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            if [ ! -d .git ]; then
              echo "Cloning repository..."
              git clone https://github.com/your-username/your-repo.git .
            else
              echo "Updating repository..."
              git fetch --all
              git reset --hard origin/main
            fi
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            npm ci --production
            
            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
            npm run build
            
            # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if [ ! -f .env ]; then
              echo "Creating .env file..."
              cp .env.example .env || echo "No .env.example found"
            fi
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–æ–∫–µ—Ä —Å –ë–î (–µ—Å–ª–∏ –µ—Å—Ç—å docker-compose.yml)
            if [ -f docker-compose.yml ]; then
              echo "Starting Docker containers..."
              docker-compose up -d
            fi
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PM2
            pm2 start dist/main.js --name "my-nest-app" --log logs/app.log
            pm2 save
            pm2 startup
            
            echo "‚úÖ NestJS application deployed successfully!"
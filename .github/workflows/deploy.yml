name: Deploy to home server - Server Build

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to home server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            echo "üöÄ Deploying to cloud.ru server..."

            PROJECT_DIR="/home/${{ secrets.VM_USERNAME }}/tomilo-lib-server"
            cd "$PROJECT_DIR"

            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git fetch origin
            git reset --hard origin/main

            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ MongoDB –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
            if ! command -v mongod &> /dev/null; then
              echo "üì¶ Installing MongoDB..."
              
              # –°–∫–∞—á–∏–≤–∞–µ–º –ø–∞–∫–µ—Ç—ã MongoDB
              wget https://repo.mongodb.org/apt/ubuntu/dists/jammy/mongodb-org/6.0/multiverse/binary-amd64/mongodb-org-server_6.0.15_amd64.deb
              wget https://repo.mongodb.org/apt/ubuntu/dists/jammy/mongodb-org/6.0/multiverse/binary-amd64/mongodb-org-shell_6.0.15_amd64.deb
              wget https://repo.mongodb.org/apt/ubuntu/dists/jammy/mongodb-org/6.0/multiverse/binary-amd64/mongodb-org-mongos_6.0.15_amd64.deb
              wget https://repo.mongodb.org/apt/ubuntu/dists/jammy/mongodb-org/6.0/multiverse/binary-amd64/mongodb-org-tools_6.0.15_amd64.deb

              # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–∫–µ—Ç—ã
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S dpkg -i mongodb-org-*.deb
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt-get install -f  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
              
              # –û—á–∏—â–∞–µ–º —Å–∫–∞—á–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
              rm -f mongodb-org-*.deb
              
              echo "‚úÖ MongoDB installed successfully"
            else
              echo "‚úÖ MongoDB already installed"
            fi

            # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
            if grep -q "MONGODB_CONFIG_OVERRIDE_NOFORK" /etc/environment; then
              echo "üîÑ Removing MONGODB_CONFIG_OVERRIDE_NOFORK from environment..."
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S sed -i '/MONGODB_CONFIG_OVERRIDE_NOFORK/d' /etc/environment
            fi

            # –¢–∞–∫–∂–µ —É–±–∏—Ä–∞–µ–º –∏–∑ –ø—Ä–æ—Ñ–∏–ª–µ–π –µ—Å–ª–∏ –µ—Å—Ç—å
            for profile in ~/.bashrc ~/.profile ~/.bash_profile; do
              if [ -f "$profile" ] && grep -q "MONGODB_CONFIG_OVERRIDE_NOFORK" "$profile"; then
                echo "üîÑ Removing MONGODB_CONFIG_OVERRIDE_NOFORK from $profile..."
                sed -i '/MONGODB_CONFIG_OVERRIDE_NOFORK/d' "$profile"
              fi
            done

            # –û–±–Ω–æ–≤–ª—è–µ–º environment
            source /etc/environment 2>/dev/null || true

            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–∞–Ω–Ω—ã—Ö MongoDB –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            echo "${{ secrets.VM_PASSWORD }}" | sudo -S mkdir -p /data/db
            echo "${{ secrets.VM_PASSWORD }}" | sudo -S chown mongodb:mongodb /data/db 2>/dev/null || true

            # –ó–∞–ø—É—Å–∫–∞–µ–º –∏ –≤–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É MongoDB
            echo "üîÑ Starting MongoDB..."
            echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl daemon-reload
            echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl stop mongod 2>/dev/null || true
            echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl start mongod
            echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl enable mongod
            sleep 5

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å MongoDB
            if echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl is-active --quiet mongod; then
              echo "‚úÖ MongoDB is running"
            else
              echo "‚ùå MongoDB failed to start, checking logs..."
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S journalctl -u mongod --no-pager -n 20
              
              # –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞
              echo "üîÑ Trying alternative startup method..."
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S mkdir -p /var/lib/mongodb
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S chown mongodb:mongodb /var/lib/mongodb
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S mongod --fork --logpath /var/log/mongodb/mongod.log --dbpath /var/lib/mongodb
              sleep 3
              
              if pgrep mongod > /dev/null; then
                echo "‚úÖ MongoDB started manually"
              else
                echo "‚ùå MongoDB still failed to start"
                exit 1
              fi
            fi

            # –ü–æ–¥–≥—Ä—É–∂–∞–µ–º nvm, –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              source "$HOME/.nvm/nvm.sh"
            else
              echo "nvm is not installed. Installing nvm..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
              source "$HOME/.nvm/nvm.sh"
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js 20
            if ! nvm ls 20 &> /dev/null; then
              echo "Installing Node.js 20..."
              nvm install 20
            fi
            nvm use 20
            nvm alias default 20

            # –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "Installing dependencies..."
            rm -rf node_modules
            npm install

            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if [ -f create-user.js ]; then
              echo "Creating MongoDB user..."
              sleep 5  # –î–∞–µ–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ MongoDB –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
              node create-user.js || echo "User creation completed"
            fi

            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            npm run build

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–±–æ—Ä–∫—É
            if [ -f dist/main.js ]; then
              echo "Build successful"
            else
              echo "Build failed!"
              exit 1
            fi

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            pm2 stop tomilo-lib-server 2>/dev/null || true
            pm2 delete tomilo-lib-server 2>/dev/null || true
            pm2 start dist/main.js --name "tomilo-lib-server"
            
            # –ñ–¥–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º
            sleep 5
            echo "PM2 status:"
            pm2 status
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏
            if pm2 status | grep -q "errored"; then
              echo "Application errors:"
              pm2 logs tomilo-lib-server --lines 20
              exit 1
            else
              echo "‚úÖ Successfully deployed!"
            fi
name: Deploy to Cloud.ru - Server Build

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to cloud.ru server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            echo "üöÄ Deploying to cloud.ru server..."

            # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            PROJECT_DIR="/home/${{ secrets.VM_USERNAME }}/tomilo-lib-server"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            echo "Current directory: $(pwd)"

            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH –¥–ª—è GitHub (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á)
            if [ -n "${{ secrets.GITHUB_SSH_KEY }}" ]; then
              mkdir -p ~/.ssh
              echo "${{ secrets.GITHUB_SSH_KEY }}" > ~/.ssh/github_key
              chmod 600 ~/.ssh/github_key
              ssh-keyscan github.com >> ~/.ssh/known_hosts
              
              # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è SSH –∫–ª—é—á–∞
              git config --global core.sshCommand "ssh -i ~/.ssh/github_key -o StrictHostKeyChecking=no"
            fi

            # –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            if [ ! -d .git ]; then
              echo "Cloning repository for the first time..."
              if [ -n "${{ secrets.GITHUB_SSH_KEY }}" ]; then
                git clone git@github.com:${{ github.repository }}.git .
              else
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º HTTPS –µ—Å–ª–∏ –Ω–µ—Ç SSH –∫–ª—é—á–∞
                git clone https://github.com/${{ github.repository }}.git .
              fi
            else
              echo "Updating existing repository..."
              git fetch origin
              git reset --hard origin/main
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–∞–ø–∫–µ
            echo "Project contents:"
            ls -la
            echo "Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º MongoDB –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
            if ! command -v mongod &> /dev/null; then
              echo "Installing MongoDB..."
              # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π MongoDB
              wget -qO - https://www.mongodb.org/static/pgp/server-4.4.asc | sudo apt-key add -
              echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/4.4 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.4.list
              
              # –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–∫–µ—Ç—ã –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º MongoDB
              sudo apt-get update
              sudo apt-get install -y mongodb-org
              
              # –ó–∞–ø—É—Å–∫–∞–µ–º –∏ –≤–∫–ª—é—á–∞–µ–º MongoDB –∫–∞–∫ —Å–ª—É–∂–±—É
              sudo systemctl start mongod
              sudo systemctl enable mongod
            else
              echo "MongoDB is already installed"
            fi

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Node.js
            npm install

            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            cp .env.example .env

            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è MongoDB –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            echo "Creating MongoDB user..."
            node create-user.js

            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            npm run build

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            pm2 stop tomilo-lib-server || true
            pm2 delete tomilo-lib-server || true
            pm2 start dist/main.js --name "tomilo-lib-server"
            pm2 save
            pm2 startup

            # –û—á–∏—Å—Ç–∫–∞
            if [ -f ~/.ssh/github_key ]; then
              rm -f ~/.ssh/github_key
            fi

            echo "‚úÖ Successfully deployed!"

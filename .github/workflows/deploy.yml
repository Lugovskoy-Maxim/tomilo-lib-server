name: Deploy to home server - Docker

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to home server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            echo "üöÄ Deploying to cloud.ru server with Docker..."

            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose V2 –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if ! docker compose version &> /dev/null; then
              echo "üì¶ Installing Docker Compose V2..."
              
              # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
              sudo apt remove -y docker-compose 2>/dev/null || true
              
              # –°–∫–∞—á–∏–≤–∞–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫ Docker Compose
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              sudo curl -SL https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose
              
              # –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
              
              # –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
              sudo ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/bin/docker-compose
              
              echo "‚úÖ Docker Compose V2 installed"
            else
              echo "‚úÖ Docker Compose is already installed"
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é
            echo "Docker Compose version:"
            docker compose version

            # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            PROJECT_DIR="/home/${{ secrets.VM_USERNAME }}/tomilo-lib-server"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            echo "Current directory: $(pwd)"

            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH –¥–ª—è GitHub (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á)
            if [ -n "${{ secrets.GITHUB_SSH_KEY }}" ]; then
              mkdir -p ~/.ssh
              echo "${{ secrets.GITHUB_SSH_KEY }}" > ~/.ssh/github_key
              chmod 600 ~/.ssh/github_key
              ssh-keyscan github.com >> ~/.ssh/known_hosts
              
              # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è SSH –∫–ª—é—á–∞
              git config --global core.sshCommand "ssh -i ~/.ssh/github_key -o StrictHostKeyChecking=no"
            fi

            # –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            if [ ! -d .git ]; then
              echo "Cloning repository for the first time..."
              if [ -n "${{ secrets.GITHUB_SSH_KEY }}" ]; then
                git clone git@github.com:${{ github.repository }}.git .
              else
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º HTTPS –µ—Å–ª–∏ –Ω–µ—Ç SSH –∫–ª—é—á–∞
                git clone https://github.com/${{ github.repository }}.git .
              fi
            else
              echo "Updating existing repository..."
              git fetch origin
              git reset --hard origin/main
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–∞–ø–∫–µ
            echo "Project contents:"
            ls -la
            echo "Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é Node.js —á–µ—Ä–µ–∑ nvm
            echo "üîß Setting up Node.js 20..."
            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              source "$HOME/.nvm/nvm.sh"
            else
              echo "Installing nvm..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
              source "$HOME/.nvm/nvm.sh"
            fi

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js 20 –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
            if ! nvm ls 20 &> /dev/null; then
              echo "Installing Node.js 20..."
              nvm install 20
            fi
            nvm use 20
            nvm alias default 20

            echo "Node.js version: $(node --version)"
            echo "npm version: $(npm --version)"

            # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤ 
            if [ -f .env.example ]; then
              cp .env.example .env
              echo "‚úÖ .env created from example"
            fi

            if [ -f docker-compose.yml.example ]; then
              cp docker-compose.yml.example docker-compose.yml
              echo "‚úÖ docker-compose.yml created from example"
            fi

            # –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π Node
            echo "Installing dependencies with Node 20..."
            rm -rf node_modules
            npm install

            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            npm run build

            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å Docker Compose V2
            echo "üê≥ Starting Docker containers..."
            docker compose down || true
            docker compose up -d --build

            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            sleep 10

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üìä Container status:"
            docker compose ps

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
            echo "üìã Application logs:"
            docker compose logs app --tail=20

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            echo "üè• Health check..."
            if curl -f http://localhost:3001/health 2>/dev/null || curl -f http://localhost:3001 2>/dev/null; then
              echo "‚úÖ Application is healthy!"
            else
              echo "‚ö†Ô∏è  Application health check failed, but continuing..."
              docker compose logs app --tail=30
            fi

            # –û—á–∏—Å—Ç–∫–∞
            if [ -f ~/.ssh/github_key ]; then
              rm -f ~/.ssh/github_key
            fi

            echo "‚úÖ Successfully deployed with Docker!"
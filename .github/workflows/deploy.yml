name: Deploy to Cloud.ru - Server Build

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to cloud.ru server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            echo "üöÄ Deploying to cloud.ru server..."

            # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            PROJECT_DIR="/home/${{ secrets.VM_USERNAME }}/tomilo-lib-server"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            echo "Current directory: $(pwd)"

            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH –¥–ª—è GitHub
            if [ -n "${{ secrets.GITHUB_SSH_KEY }}" ]; then
              mkdir -p ~/.ssh
              echo "${{ secrets.GITHUB_SSH_KEY }}" > ~/.ssh/github_key
              chmod 600 ~/.ssh/github_key
              ssh-keyscan github.com >> ~/.ssh/known_hosts
              git config --global core.sshCommand "ssh -i ~/.ssh/github_key -o StrictHostKeyChecking=no"
            fi

            # –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            if [ ! -d .git ]; then
              echo "Cloning repository for the first time..."
              if [ -n "${{ secrets.GITHUB_SSH_KEY }}" ]; then
                git clone git@github.com:${{ github.repository }}.git .
              else
                git clone https://github.com/${{ github.repository }}.git .
              fi
            else
              echo "Updating existing repository..."
              git fetch origin
              git reset --hard origin/main
            fi

            echo "Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"

            # –û—á–∏—â–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏ MongoDB
            echo "${{ secrets.VM_PASSWORD }}" | sudo -S rm -f /etc/apt/sources.list.d/mongodb-org-4.4.list

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –∑–∞–¥–∞—á–∞)
            if ! command -v node &> /dev/null || ! command -v npm &> /dev/null; then
              echo "Installing Node.js..."
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt-get update
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt-get install -y curl
              
              # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js 18.x (LTS)
              curl -fsSL https://deb.nodesource.com/setup_18.x | echo "${{ secrets.VM_PASSWORD }}" | sudo -S -E bash -
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt-get install -y nodejs
              
              # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –≥–ª–æ–±–∞–ª—å–Ω–æ
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S npm install -g pm2
            else
              echo "Node.js is already installed"
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É Node.js
            echo "Node.js version: $(node --version)"
            echo "npm version: $(npm --version)"

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º MongoDB (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
            if ! command -v mongod &> /dev/null; then
              echo "Installing MongoDB..."
              
              # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º MongoDB –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ Ubuntu (–ø—Ä–æ—â–µ)
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt-get install -y mongodb
              
              # –ò–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Docker
              # echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt-get install -y docker.io
              # echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl start docker
              # echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl enable docker
              # echo "${{ secrets.VM_PASSWORD }}" | sudo -S docker run -d -p 27017:27017 --name mongodb mongo:latest
            else
              echo "MongoDB is already installed"
            fi

            # –ó–∞–ø—É—Å–∫–∞–µ–º MongoDB –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if command -v mongod &> /dev/null; then
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl start mongodb || true
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl enable mongodb || true
            fi

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
            echo "Installing project dependencies..."
            npm install

            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            if [ -f .env.example ]; then
              cp .env.example .env
            fi

            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è MongoDB –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if [ -f create-user.js ]; then
              echo "Creating MongoDB user..."
              node create-user.js || echo "MongoDB user creation skipped or failed"
            fi

            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            echo "Building application..."
            npm run build

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PM2
            echo "Restarting application with PM2..."
            pm2 stop tomilo-lib-server 2>/dev/null || true
            pm2 delete tomilo-lib-server 2>/dev/null || true
            pm2 start dist/main.js --name "tomilo-lib-server"
            pm2 save
            pm2 startup 2>/dev/null || echo "PM2 startup setup skipped"

            # –û—á–∏—Å—Ç–∫–∞
            if [ -f ~/.ssh/github_key ]; then
              rm -f ~/.ssh/github_key
            fi

            echo "‚úÖ Successfully deployed!"

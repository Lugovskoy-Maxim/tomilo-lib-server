name: Deploy to Cloud.ru - Server Build

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to cloud.ru server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            echo "üöÄ Deploying to cloud.ru server..."

            PROJECT_DIR="/home/${{ secrets.VM_USERNAME }}/tomilo-lib-server"
            cd "$PROJECT_DIR"

            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git fetch origin
            git reset --hard origin/main

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            npm install

            # –£–±–µ–¥–∏–º—Å—è —á—Ç–æ MongoDB —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –∑–∞–ø—É—â–µ–Ω–∞
            if ! command -v mongod &> /dev/null; then
              echo "Installing MongoDB..."
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt update
              
              # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è MongoDB
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt install -y wget gnupg
              
              # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π MongoDB
              wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt-key add -
              echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | echo "${{ secrets.VM_PASSWORD }}" | sudo -S tee /etc/apt/sources.list.d/mongodb-org-6.0.list
              
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt update
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt install -y mongodb-org
              
              # –ó–∞–ø—É—Å–∫–∞–µ–º MongoDB
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl start mongod
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl enable mongod
              echo "MongoDB installed and started"
            else
              echo "MongoDB is already installed"
            fi

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º MongoDB —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç
            echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl restart mongod

            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ MongoDB
            sleep 3

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å MongoDB
            echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl status mongod --no-pager

            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if [ -f create-user.js ]; then
              echo "Creating MongoDB user..."
              # –î–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ MongoDB
              sleep 5
              node create-user.js || echo "User creation completed or skipped"
            fi

            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            npm run build

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
            echo "Testing application startup..."
            timeout 10s node dist/main.js || echo "Application test completed"

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ PM2
            pm2 stop tomilo-lib-server 2>/dev/null || true
            pm2 delete tomilo-lib-server 2>/dev/null || true
            pm2 start dist/main.js --name "tomilo-lib-server"
            
            # –ñ–¥–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            sleep 5
            echo "PM2 status:"
            pm2 status
            
            echo "‚úÖ Deployment completed!"

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏ –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–ø–∞–ª–æ
            if pm2 status | grep -q "errored"; then
              echo "‚ùå Application has errors. Showing logs:"
              pm2 logs tomilo-lib-server --lines 30
              exit 1
            fi
name: Deploy to Cloud.ru - Server Build

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to cloud.ru server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            echo "üöÄ Deploying to cloud.ru server..."

            # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            PROJECT_DIR="/home/${{ secrets.VM_USERNAME }}/tomilo-lib-server"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            echo "Current directory: $(pwd)"

            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH –¥–ª—è GitHub
            if [ -n "${{ secrets.GITHUB_SSH_KEY }}" ]; then
              mkdir -p ~/.ssh
              echo "${{ secrets.GITHUB_SSH_KEY }}" > ~/.ssh/github_key
              chmod 600 ~/.ssh/github_key
              ssh-keyscan github.com >> ~/.ssh/known_hosts
              git config --global core.sshCommand "ssh -i ~/.ssh/github_key -o StrictHostKeyChecking=no"
            fi

            # –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            if [ ! -d .git ]; then
              echo "Cloning repository for the first time..."
              if [ -n "${{ secrets.GITHUB_SSH_KEY }}" ]; then
                git clone git@github.com:${{ github.repository }}.git .
              else
                git clone https://github.com/${{ github.repository }}.git .
              fi
            else
              echo "Updating existing repository..."
              git fetch origin
              git reset --hard origin/main
            fi

            echo "Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js –∏ npm –ø—Ä–∞–≤–∏–ª—å–Ω–æ
            if ! command -v node &> /dev/null || ! command -v npm &> /dev/null; then
              echo "Installing Node.js and npm..."
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt-get update
              
              # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º curl –µ—Å–ª–∏ –Ω–µ—Ç
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt-get install -y curl
              
              # –°–∫–∞—á–∏–≤–∞–µ–º –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Node.js (–≤–∫–ª—é—á–∞—è npm)
              curl -fsSL https://deb.nodesource.com/setup_18.x -o node_setup.sh
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S bash node_setup.sh
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt-get install -y nodejs
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
              echo "Node.js version: $(node --version)"
              echo "npm version: $(npm --version)"
              
              # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –≥–ª–æ–±–∞–ª—å–Ω–æ
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S npm install -g pm2
              
              # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
              rm -f node_setup.sh
            else
              echo "Node.js is already installed"
              echo "Node.js version: $(node --version)"
              echo "npm version: $(npm --version)"
            fi

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º MongoDB –∏—Å–ø–æ–ª—å–∑—É—è Docker (–Ω–∞–¥–µ–∂–Ω–µ–µ)
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt-get update
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S apt-get install -y docker.io
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl start docker
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S systemctl enable docker
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S usermod -aG docker $USER
            else
              echo "Docker is already installed"
            fi

            # –ó–∞–ø—É—Å–∫–∞–µ–º MongoDB –≤ Docker
            if ! echo "${{ secrets.VM_PASSWORD }}" | sudo -S docker ps | grep mongodb &> /dev/null; then
              echo "Starting MongoDB in Docker..."
              echo "${{ secrets.VM_PASSWORD }}" | sudo -S docker run -d \
                --name mongodb \
                -p 27017:27017 \
                -e MONGO_INITDB_ROOT_USERNAME=admin \
                -e MONGO_INITDB_ROOT_PASSWORD=password \
                --restart unless-stopped \
                mongo:latest
              
              # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ MongoDB
              sleep 10
            else
              echo "MongoDB is already running in Docker"
            fi

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
            echo "Installing project dependencies..."
            npm install

            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            if [ -f .env.example ]; then
              cp .env.example .env
            fi

            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è MongoDB –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if [ -f create-user.js ]; then
              echo "Creating MongoDB user..."
              # –î–∞–µ–º –≤—Ä–µ–º—è MongoDB –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
              sleep 5
              node create-user.js || echo "MongoDB user creation completed or skipped"
            fi

            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            echo "Building application..."
            npm run build

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PM2
            echo "Restarting application with PM2..."
            pm2 stop tomilo-lib-server 2>/dev/null || true
            pm2 delete tomilo-lib-server 2>/dev/null || true
            pm2 start dist/main.js --name "tomilo-lib-server"
            pm2 save
            echo "${{ secrets.VM_PASSWORD }}" | sudo -S env PATH=$PATH:/usr/bin pm2 startup -u ${{ secrets.VM_USERNAME }} --hp /home/${{ secrets.VM_USERNAME }} 2>/dev/null || echo "PM2 startup setup skipped"

            # –û—á–∏—Å—Ç–∫–∞
            if [ -f ~/.ssh/github_key ]; then
              rm -f ~/.ssh/github_key
            fi

            echo "‚úÖ Successfully deployed!"
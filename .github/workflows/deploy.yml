name: Deploy NestJS to VM

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    # - name: Run tests
    #   run: npm test
      
    - name: Build project
      run: npm run build
      
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          echo "üöÄ Starting deployment..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
          cd /home/maxim/apps/my-nest-app
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ)
          pm2 stop my-nest-app || true
          pm2 delete my-nest-app || true
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π –∫–æ–¥
          git fetch --all
          git reset --hard origin/main
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          npm ci --production
          
          # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
          npm run build
          
          # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -f .env ]; then
            echo "Creating .env file..."
            cp .env.example .env
          fi
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PM2
          pm2 start dist/main.js --name "my-nest-app" --log logs/app.log
          pm2 save
          pm2 startup
          
          echo "‚úÖ NestJS application deployed successfully!"
name: Deploy to Cloud.ru - Server Build

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy and build on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            echo "üöÄ Deploying to cloud.ru server..."
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH –¥–ª—è GitHub
            mkdir -p ~/.ssh
            echo "${{ secrets.GITHUB_SSH_KEY }}" > ~/.ssh/github_key
            chmod 600 ~/.ssh/github_key
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            
            cd /home/${{ secrets.VM_USERNAME }}/tomilo-lib-server/
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git fetch origin
            git reset --hard origin/main
            
            # –í—Å—ë –¥–µ–ª–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            npm install
            npm run build
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker-compose down || true
            docker-compose up -d --build
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            pm2 restart tomilo-lib-server
            
            # –û—á–∏—Å—Ç–∫–∞
            rm -f ~/.ssh/github_key
            
            echo "‚úÖ Successfully deployed!"
